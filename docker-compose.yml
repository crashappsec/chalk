networks:
  chalk:
  imds:
    ipam:
      driver: default
      config:
        - subnet: 169.254.169.254/24
        
services:
  chalk:
    build:
      context: .
      target: deps
    command: nimble ${CHALK_BUILD:-release}
    working_dir: /chalk
    volumes:
      - .:/chalk/

  server:
    build:
      context: ./server
      target: deps
    networks:
      chalk:
        aliases:
          - chalk.local
    ports:
      - 8585:8585
    working_dir: /chalk/server
    volumes:
      - .:/chalk
    healthcheck:
      test:
        - CMD-SHELL
        - sh -c "curl -f http://localhost:8585/health"
      start_period: 30s
      interval: 1s

  tests:
    build:
      context: ./tests
    volumes:
      - .:/chalk
      - /var/run/docker.sock:/var/run/docker.sock
    working_dir: /chalk/tests
    depends_on:
      registry:
        condition: service_healthy
      server:
        condition: service_healthy
    environment:
      GITHUB_ACTIONS: ${GITHUB_ACTIONS:-}

  registry:
    image: registry:2
    ports:
      - "5044:5044"
    environment:
      - REGISTRY_HTTP_ADDR=0.0.0.0:5044
    networks:
      - chalk
    healthcheck:
      test:
        - CMD-SHELL
        - sh -c "echo 'GET / HTTP/1.1' | nc -v localhost 5044"
      start_period: 30s
      interval: 1s
