# Copyright (c) 2023, Crash Override, Inc.
#
# This file is part of Chalk
# (see https://crashoverride.com/docs/chalk)
from pathlib import Path
import zipfile

import pytest

from .chalk.runner import Chalk
from .conf import ZIPS
from .utils.log import get_logger


logger = get_logger()

# Test data fixtures
PYTHON_LAMBDA_ZIP = ZIPS / "python" / "my_deployment_package.zip"
NODEJS_LAMBDA_ZIP = ZIPS / "nodejs" / "function.zip"
GOLANG_LAMBDA_ZIP = ZIPS / "golang" / "myFunction.zip"
MISC_LAMBDA_ZIP = ZIPS / "misc" / "misc.zip"
EMPTY_ZIP = ZIPS / "empty" / "empty.zip"


@pytest.mark.slow()
@pytest.mark.parametrize(
    "copy_files",
    [
        [NODEJS_LAMBDA_ZIP],
        [PYTHON_LAMBDA_ZIP],
    ],
    indirect=True,
)
@pytest.mark.parametrize("virtual", [True, False])
@pytest.mark.parametrize("inject_binary_into_zip", [True, False])
def test_valid_slow(
    tmp_data_dir: Path,
    chalk: Chalk,
    copy_files: list[Path],
    virtual: bool,
    inject_binary_into_zip: bool,
):
    test_file = copy_files[0]

    # chalk reports generated by insertion, json array that has one element
    insert = chalk.insert(
        artifact=tmp_data_dir,
        virtual=virtual,
        inject_binary_into_zip=inject_binary_into_zip,
    )
    assert insert.report.marks_by_path.contains({str(test_file): {}})

    # chalk binary is not injected if --virtual flag is present
    if inject_binary_into_zip:
        assert maybe_contains_chalk_binary(test_file, virtual)
    # array of json chalk objects as output, of which we are only expecting one
    extract = chalk.extract(artifact=tmp_data_dir, virtual=virtual)
    if not virtual:
        assert extract.mark.contains(insert.mark.if_exists())
        assert extract.report.marks_by_path.contains({str(test_file): {}})


@pytest.mark.parametrize(
    "copy_files",
    [
        # empty zip file does not get chalked, so no artifact info
        [EMPTY_ZIP],
    ],
    indirect=True,
)
@pytest.mark.parametrize("virtual", [True, False])
@pytest.mark.parametrize("inject_binary_into_zip", [True, False])
def test_empty(
    tmp_data_dir: Path,
    copy_files: list[Path],
    chalk: Chalk,
    virtual: bool,
    inject_binary_into_zip: bool,
):
    # no _CHALK will be generated on an unchalked empty zip
    assert chalk.insert(
        artifact=tmp_data_dir,
        virtual=virtual,
        inject_binary_into_zip=inject_binary_into_zip,
        expecting_chalkmarks=False,
    )
    assert chalk.extract(
        artifact=tmp_data_dir,
        virtual=virtual,
        expecting_chalkmarks=False,
    )


@pytest.mark.parametrize(
    "copy_files",
    [
        [MISC_LAMBDA_ZIP],
        [GOLANG_LAMBDA_ZIP],
    ],
    indirect=True,
)
@pytest.mark.parametrize("virtual", [True, False])
@pytest.mark.parametrize("inject_binary_into_zip", [True, False])
def test_valid(
    tmp_data_dir: Path,
    chalk: Chalk,
    copy_files: list[Path],
    virtual: bool,
    inject_binary_into_zip: bool,
):
    test_file = copy_files[0]

    # chalk reports generated by insertion, json array that has one element
    insert = chalk.insert(
        artifact=tmp_data_dir,
        virtual=virtual,
        inject_binary_into_zip=inject_binary_into_zip,
    )
    # we are only checking the ZIP chalk mark, not any of the subchalks
    assert insert.report.marks_by_path.contains({str(test_file): {}})

    # array of json chalk objects as output, of which we are only expecting one
    extract = chalk.extract(artifact=tmp_data_dir, virtual=virtual)
    if not virtual:
        assert extract.report.marks_by_path.contains({str(test_file): {}})
        assert extract.mark.contains(insert.mark.if_exists())
    if inject_binary_into_zip:
        assert maybe_contains_chalk_binary(test_file, virtual)


def maybe_contains_chalk_binary(zip_path: Path, virtual: bool):
    """Helper function to verify chalk binary in the zip file."""
    with zipfile.ZipFile(zip_path, "r") as zip_ref:
        if virtual:
            # virtual mode should not modify zip archive
            return "chalk" not in zip_ref.namelist()
        else:
            # Verify the chalk binary was added
            return "chalk" in zip_ref.namelist()
